{% extends "base.html" %}

{% block title %}Camera & Control - Hanah IoT{% endblock %}
{% block page_title %}Live Camera & Robot Control{% endblock %}
{% block breadcrumb %}Camera{% endblock %}

{% block content %}
<div class="camera-container">
  <div class="camera-grid">
    
    <div class="camera-card main-feed">
      <div class="card-header">
        <div class="camera-header-left">
          <i class="fas fa-robot camera-icon"></i>
          <div>
            <h3>Live Vision Feed</h3>
            <div class="camera-status">
              <span class="status-indicator online">
                <div class="status-dot"></div>
                <span class="stream-text">Online</span>
              </span>
              <span class="camera-id">CAM-01 • Face Tracking Ready</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="video-container">
        <div class="video-wrapper">
          <img src="{{ url_for('video_feed') }}" alt="Robot Camera Stream" class="live-feed" id="cameraFeed" style="width: 100%; border-radius: 8px;">
          <div class="video-overlay">
            <div class="recording-indicator" id="recIndicator" style="display: none;">
              <div class="recording-dot"></div><span>REC</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="video-controls">
        <button class="control-btn" id="btnTracking" onclick="toggleTracking()">
          <i class="fas fa-crosshairs"></i>
          <span>AI Tracking: OFF</span>
        </button>
        <button class="control-btn" onclick="location.reload()">
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
        <button class="control-btn" id="btnMic" 
                onmousedown="startRecording()" onmouseup="stopRecording()"
                ontouchstart="startRecording()" ontouchend="stopRecording()">
          <i class="fas fa-microphone"></i>
          <span>Hold to Talk</span>
        </button>
      </div>
    </div>

    <div class="camera-card control-panel">
      <div class="card-header">
        <h3><i class="fas fa-gamepad"></i> Manual Control</h3>
      </div>
      
      <div class="control-content">
        <div class="dpad-container" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; max-width: 220px; margin: 0 auto;">
           <div></div>
           <button class="dpad-btn" id="btn-fw"
                   onmousedown="startMove('FW')" onmouseup="stopMove()" 
                   ontouchstart="startMove('FW')" ontouchend="stopMove()">
             <i class="fas fa-arrow-up"></i>
           </button>
           <div></div>

           <button class="dpad-btn" id="btn-tl"
                   onmousedown="startMove('TL')" onmouseup="stopMove()" 
                   ontouchstart="startMove('TL')" ontouchend="stopMove()">
             <i class="fas fa-arrow-left"></i>
           </button>
           
           <button class="dpad-btn stop-btn" id="btn-stop" onclick="stopMove()" style="background: #ef4444;">
             <i class="fas fa-stop"></i>
           </button>
           
           <button class="dpad-btn" id="btn-tr"
                   onmousedown="startMove('TR')" onmouseup="stopMove()" 
                   ontouchstart="startMove('TR')" ontouchend="stopMove()">
             <i class="fas fa-arrow-right"></i>
           </button>

           <div></div>
           <button class="dpad-btn" id="btn-bw"
                   onmousedown="startMove('BW')" onmouseup="stopMove()" 
                   ontouchstart="startMove('BW')" ontouchend="stopMove()">
             <i class="fas fa-arrow-down"></i>
           </button>
           <div></div>
        </div>
        
        <div style="margin-top: 20px; padding: 0 10px;">
            <label style="color: #cbd5e1; font-size: 0.9rem;">Speed: <span id="speedVal">150</span></label>
            <input type="range" id="speedRange" min="0" max="255" value="150" style="width: 100%; margin-top: 5px;" oninput="document.getElementById('speedVal').innerText = this.value">
        </div>
        
        <div style="margin-top: 15px; text-align: center; color: #64748b; font-size: 0.8rem;">
            Use <b>Arrow Keys</b> or <b>W A S D</b> to move
        </div>
      </div>
    </div>

  </div>
</div>

<script>
    // --- LOGIC TRUYỀN GIỌNG NÓI TỪ XA ---
  let mediaRecorder;
  let audioChunks = [];
  
  async function startRecording() {
      audioChunks = [];
      const btnMic = document.getElementById('btnMic');
      
      try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);
          
          mediaRecorder.ondataavailable = (event) => {
              audioChunks.push(event.data);
          };
        
          mediaRecorder.onstop = async () => {
              const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
              const formData = new FormData();
              formData.append('audio', audioBlob, 'voice.wav');
          
              // Gửi file âm thanh lên Pi
              fetch('/api/play-remote-audio', {
                  method: 'POST',
                  body: formData
              });
              
              // Dừng các track của mic để tắt đèn báo ghi âm trên trình duyệt
              stream.getTracks().forEach(track => track.stop());
          };
        
          mediaRecorder.start();
          btnMic.style.background = '#ef4444'; // Đổi sang màu đỏ khi đang nói
          btnMic.querySelector('span').innerText = "Speaking...";
          console.log("Ghi âm bắt đầu...");
      } catch (err) {
          console.error("Không thể truy cập Microphone:", err);
          alert("Vui lòng cấp quyền Microphone cho trình duyệt.");
      }
  }
  
  function stopRecording() {
      if (mediaRecorder && mediaRecorder.state === "recording") {
          mediaRecorder.stop();
          const btnMic = document.getElementById('btnMic');
          btnMic.style.background = ''; // Reset màu
          btnMic.querySelector('span').innerText = "Hold to Talk";
          console.log("Ghi âm kết thúc.");
      }
  }
  // --- 1. LOGIC GỬI LỆNH (GIỮ NGUYÊN) ---
  let moveInterval = null;
  
  function startMove(cmd) {
      if (moveInterval) clearInterval(moveInterval); 
      
      const speed = document.getElementById('speedRange').value;
      const duration = 250; 
      
      sendCommand(cmd, speed, duration);
      moveInterval = setInterval(() => {
          sendCommand(cmd, speed, duration);
      }, 200);
  }

  function stopMove() {
      if (moveInterval) {
          clearInterval(moveInterval);
          moveInterval = null;
      }
      sendCommand('STOP', 0, 0);
  }

  async function sendCommand(cmd, speed, duration) {
      try {
          await fetch('/api/move', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({cmd, speed, duration})
          });
      } catch (e) {
          console.error("Lỗi gửi lệnh:", e);
      }
  }

  // --- 2. LOGIC BÀN PHÍM (MỚI) ---
  let activeKey = null; // Biến lưu phím đang được giữ để chống lặp

  document.addEventListener('keydown', function(event) {
      // Nếu đang giữ phím thì bỏ qua (chống lặp event của hệ điều hành)
      if (activeKey === event.code) return; 
      
      let cmd = null;
      let btnId = null;

      switch(event.code) {
          case 'ArrowUp':
          case 'KeyW':
              cmd = 'FW'; btnId = 'btn-fw'; break;
          case 'ArrowDown':
          case 'KeyS':
              cmd = 'BW'; btnId = 'btn-bw'; break;
          case 'ArrowLeft':
          case 'KeyA':
              cmd = 'TL'; btnId = 'btn-tl'; break;
          case 'ArrowRight':
          case 'KeyD':
              cmd = 'TR'; btnId = 'btn-tr'; break;
          case 'Space':
              stopMove(); // Phím Space để phanh gấp
              document.getElementById('btn-stop').classList.add('active');
              return; 
      }

      if (cmd) {
          // Ngăn cuộn trang khi bấm nút mũi tên
          event.preventDefault(); 
          
          activeKey = event.code; // Đánh dấu phím này đang được nhấn
          
          // Thêm hiệu ứng nút sáng lên trên màn hình
          document.getElementById(btnId).classList.add('active');
          
          // Bắt đầu di chuyển
          startMove(cmd);
      }
  });

  document.addEventListener('keyup', function(event) {
      // Chỉ dừng nếu nhả đúng cái phím đang dùng để di chuyển
      if (activeKey === event.code) {
          stopMove();
          
          // Xóa hiệu ứng sáng nút
          document.querySelectorAll('.dpad-btn').forEach(btn => btn.classList.remove('active'));
          
          activeKey = null; // Reset
      }
      
      if (event.code === 'Space') {
          document.getElementById('btn-stop').classList.remove('active');
      }
  });

  // --- 3. CÁC LOGIC KHÁC (TRACKING) ---
  let isTracking = false;
  async function toggleTracking() {
    isTracking = !isTracking;
    const btn = document.getElementById('btnTracking');
    const action = isTracking ? 'on' : 'off';
    try {
        await fetch(`/api/toggle_system/tracking/${action}`, { method: 'POST' });
        updateTrackingUI();
    } catch(e) { console.error(e); }
  }
  
  function updateTrackingUI() {
      const btn = document.getElementById('btnTracking');
      if(isTracking) {
          btn.style.background = 'var(--success-color)';
          btn.style.color = 'white';
          btn.innerHTML = '<i class="fas fa-crosshairs"></i> <span>AI Tracking: ON</span>';
      } else {
          btn.style.background = ''; 
          btn.style.color = '';
          btn.innerHTML = '<i class="fas fa-crosshairs"></i> <span>AI Tracking: OFF</span>';
      }
  }
  
  async function checkTrackingStatus() {
      try {
          const res = await fetch('/api/get_system_config');
          const config = await res.json();
          if (config.tracking) { isTracking = true; updateTrackingUI(); }
      } catch(e) {}
  }
  
  document.addEventListener('contextmenu', event => event.preventDefault());
  checkTrackingStatus();
</script>

<style>
/* CSS cho nút bấm */
.dpad-btn {
    width: 60px; height: 60px;
    border: none; border-radius: 12px;
    background: #334155; color: white;
    font-size: 1.5rem; cursor: pointer;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    transition: all 0.1s;
    user-select: none; -webkit-user-select: none;
}

/* Hiệu ứng khi nhấn chuột HOẶC nhấn phím bàn phím */
.dpad-btn:active, .dpad-btn.active { 
    background: #2563eb; 
    transform: translateY(2px);
    box-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

.stop-btn:active, .stop-btn.active { background: #dc2626; }

.video-controls { margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap; }
.control-btn { 
    padding: 10px 15px; border: 1px solid #475569; 
    background: #1e293b; color: #cbd5e1; border-radius: 6px; cursor: pointer;
    display: flex; align-items: center; gap: 8px;
}
</style>
{% endblock %}
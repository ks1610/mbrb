{% extends "base.html" %}

{% block title %}System Control - Hanah IoT{% endblock %}
{% block page_title %}System Performance Manager{% endblock %}
{% block breadcrumb %}Control Panel{% endblock %}

{% block content %}
<div class="control-container">
  <!-- Main Control Panel -->
  <div class="control-grid">
    <!-- System Control Card -->
    <div class="control-card full-width">
      <div class="card-header">
        <div class="header-left">
          <i class="fas fa-sliders-h header-icon" id="cateory-icon"></i>
          <div>
            <h3>System Resource Controller</h3>
            <p class="header-subtitle">Optimize performance and energy efficiency for Raspberry Pi</p>
          </div>
        </div>
        <div class="header-right">
          <span class="card-badge admin-badge">
            <i class="fas fa-shield-alt"></i>
            Administrator
          </span>
        </div>
      </div>
      
      <div class="card-content">
        <!-- System Overview Stats -->
        <div class="system-overview">
          <div class="overview-stat">
            <div class="stat-icon">
              <i class="fas fa-microchip"></i>
            </div>
            <div class="stat-info">
              <h4 id="diskUsage">--%</h4> 
              <p>Disk Usage</p>
            </div>
          </div>
          <div class="overview-stat">
            <div class="stat-icon">
              <i class="fas fa-memory"></i>
            </div>
            <div class="stat-info">
              <h4 id="memoryUsage">--%</h4>
              <p>Memory Usage</p>
            </div>
          </div>
          <div class="overview-stat">
            <div class="stat-icon">
              <i class="fas fa-temperature-high"></i>
            </div>
            <div class="stat-info">
              <h4 id="cpuTemp">--°C</h4>
              <p>CPU Temperature</p>
            </div>
          </div>
          <div class="overview-stat">
            <div class="stat-icon">
              <i class="fas fa-bolt"></i>
            </div>
            <div class="stat-info">
              <h4 id="powerDraw">--W</h4>
              <p>Power Draw</p>
            </div>
          </div>
        </div>

        <!-- System Services Grid -->
        <div class="services-grid">
          <!-- Camera Service -->
          <div class="service-card" id="card-camera" data-service="camera">
            <div class="service-header">
              <div class="service-icon-wrapper">
                <div class="service-icon camera">
                  <i class="fas fa-video"></i>
                </div>
              </div>
              <div class="service-info">
                <h4>Camera Service</h4>
                <p class="service-description">Live video streaming and processing</p>
              </div>
              <div class="service-status">
                <span class="status-badge" id="status-camera">LOADING</span>
                <div class="status-dot" id="dot-camera"></div>
              </div>
            </div>
            
            <div class="service-details">
              <div class="detail-item">
                <i class="fas fa-clock"></i>
                <span>Uptime: <strong id="uptime-camera">--</strong></span>
              </div>
              <div class="detail-item">
                <i class="fas fa-hdd"></i>
                <span>Storage: <strong id="storage-camera">-- MB</strong></span>
              </div>
            </div>
            
            <div class="service-controls">
              <div class="toggle-switch">
                <input type="checkbox" id="toggle-camera" class="toggle-input" onchange="toggleSystem('camera')">
                <label for="toggle-camera" class="toggle-label">
                  <span class="toggle-handle"></span>
                  <span class="toggle-text">
                    <span class="toggle-off">OFF</span>
                    <span class="toggle-on">ON</span>
                  </span>
                </label>
              </div>
              <button class="service-btn restart-btn" onclick="restartService('camera')">
                <i class="fas fa-redo"></i>
                Restart
              </button>
            </div>
          </div>

          <!-- AI Service -->
          <div class="service-card" id="card-ai" data-service="ai">
            <div class="service-header">
              <div class="service-icon-wrapper">
                <div class="service-icon ai">
                  <i class="fas fa-brain"></i>
                </div>
              </div>
              <div class="service-info">
                <h4>AI Processing (Ollama)</h4>
                <p class="service-description">Machine learning and language models</p>
              </div>
              <div class="service-status">
                <span class="status-badge" id="status-ai">LOADING</span>
                <div class="status-dot" id="dot-ai"></div>
              </div>
            </div>
            
            <div class="service-details">
              <div class="detail-item">
                <i class="fas fa-cogs"></i>
                <span>Models: <strong id="models-ai">--</strong></span>
              </div>
              <div class="detail-item">
                <i class="fas fa-chart-line"></i>
                <span>Inference: <strong id="inference-ai">-- ms</strong></span>
              </div>
            </div>
            
            <div class="service-controls">
              <div class="toggle-switch">
                <input type="checkbox" id="toggle-ai" class="toggle-input" onchange="toggleSystem('ai')">
                <label for="toggle-ai" class="toggle-label">
                  <span class="toggle-handle"></span>
                  <span class="toggle-text">
                    <span class="toggle-off">OFF</span>
                    <span class="toggle-on">ON</span>
                  </span>
                </label>
              </div>
              <button class="service-btn config-btn" onclick="configureService('ai')">
                <i class="fas fa-cog"></i>
                Configure
              </button>
            </div>
          </div>

          <!-- Microphone Service -->
          <div class="service-card" id="card-mic" data-service="mic">
            <div class="service-header">
              <div class="service-icon-wrapper">
                <div class="service-icon mic">
                  <i class="fas fa-microphone"></i>
                </div>
              </div>
              <div class="service-info">
                <h4>Audio Input</h4>
                <p class="service-description">Voice recognition and audio capture</p>
              </div>
              <div class="service-status">
                <span class="status-badge" id="status-mic">LOADING</span>
                <div class="status-dot" id="dot-mic"></div>
              </div>
            </div>
            
            <div class="service-details">
              <div class="detail-item">
                <i class="fas fa-volume-up"></i>
                <span>Sensitivity: <strong id="sensitivity-mic">--%</strong></span>
              </div>
              <div class="detail-item">
                <i class="fas fa-wave-square"></i>
                <span>Noise Level: <strong id="noise-mic">-- dB</strong></span>
              </div>
            </div>
            
            <div class="service-controls">
              <div class="toggle-switch">
                <input type="checkbox" id="toggle-mic" class="toggle-input" onchange="toggleSystem('mic')">
                <label for="toggle-mic" class="toggle-label">
                  <span class="toggle-handle"></span>
                  <span class="toggle-text">
                    <span class="toggle-off">OFF</span>
                    <span class="toggle-on">ON</span>
                  </span>
                </label>
              </div>
              <button class="service-btn test-btn" onclick="testMicrophone()">
                <i class="fas fa-play"></i>
                Test
              </button>
            </div>
          </div>

          <!-- Sound Service -->
          <div class="service-card" id="card-sound" data-service="sound">
            <div class="service-header">
              <div class="service-icon-wrapper">
                <div class="service-icon sound">
                  <i class="fas fa-volume-up"></i>
                </div>
              </div>
              <div class="service-info">
                <h4>Audio Output (TTS)</h4>
                <p class="service-description">Text-to-speech and sound playback</p>
              </div>
              <div class="service-status">
                <span class="status-badge" id="status-sound">LOADING</span>
                <div class="status-dot" id="dot-sound"></div>
              </div>
            </div>
            
            <div class="service-details">
              <div class="detail-item">
                <i class="fas fa-language"></i>
                <span>Language: <strong id="language-sound">--</strong></span>
              </div>
              <div class="detail-item">
                <i class="fas fa-wave-square"></i>
                <span>Volume: <strong id="volume-sound">--%</strong></span>
              </div>
            </div>
            
            <div class="service-controls">
              <div class="toggle-switch">
                <input type="checkbox" id="toggle-sound" class="toggle-input" onchange="toggleSystem('sound')">
                <label for="toggle-sound" class="toggle-label">
                  <span class="toggle-handle"></span>
                  <span class="toggle-text">
                    <span class="toggle-off">OFF</span>
                    <span class="toggle-on">ON</span>
                  </span>
                </label>
              </div>
              <button class="service-btn test-btn" onclick="testSound()">
                <i class="fas fa-play"></i>
                Test
              </button>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions-section">
          <h4>Quick Actions</h4>
          <div class="quick-actions-grid">
            <button class="quick-action-btn" onclick="startAllServices()">
              <i class="fas fa-play-circle"></i>
              <span>Start All</span>
            </button>
            <button class="quick-action-btn" onclick="stopAllServices()">
              <i class="fas fa-stop-circle"></i>
              <span>Stop All</span>
            </button>
            <button class="quick-action-btn" onclick="restartAllServices()">
              <i class="fas fa-redo-alt"></i>
              <span>Restart All</span>
            </button>
            <button class="quick-action-btn" onclick="optimizeSystem()">
              <i class="fas fa-magic"></i>
              <span>Optimize</span>
            </button>
            <button class="quick-action-btn danger" onclick="showPowerMenu()">
              <i class="fas fa-power-off"></i>
              <span>Power</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- System Logs Card -->
    <div class="control-card logs-card">
      <div class="card-header">
        <h3><i class="fas fa-clipboard-list"></i> System Logs</h3>
        <button class="header-btn" onclick="clearLogs()">
          <i class="fas fa-trash-alt"></i>
          Clear
        </button>
      </div>
      <div class="card-content">
        <div class="logs-container" id="logsContainer">
          <div class="log-entry">
            <div class="log-time">12:34:56</div>
            <div class="log-service">System</div>
            <div class="log-message">Control panel initialized</div>
            <div class="log-level info">INFO</div>
          </div>
          <!-- More logs will be added here -->
        </div>
        <div class="logs-controls">
          <div class="log-filter">
            <i class="fas fa-filter"></i>
            <select id="logFilter">
              <option value="all">All Logs</option>
              <option value="error">Errors Only</option>
              <option value="warning">Warnings</option>
              <option value="info">Info</option>
            </select>
          </div>
          <button class="log-refresh" onclick="refreshLogs()">
            <i class="fas fa-sync-alt"></i>
            Refresh
          </button>
        </div>
      </div>
    </div>

    <!-- Performance Chart -->
    <div class="control-card chart-card">
      <div class="card-header">
        <h3><i class="fas fa-chart-line"></i> Performance Metrics</h3>
        <div class="time-selector">
          <button class="time-btn active" data-time="1h">1H</button>
          <button class="time-btn" data-time="6h">6H</button>
          <button class="time-btn" data-time="24h">24H</button>
        </div>
      </div>
      <div class="card-content">
        <div class="chart-container">
          <canvas id="performanceChart"></canvas>
        </div>
        <div class="chart-legend">
          <div class="legend-item">
            <span class="legend-color cpu"></span>
            <span>CPU Usage</span>
          </div>
          <div class="legend-item">
            <span class="legend-color memory"></span>
            <span>Memory Usage</span>
          </div>
          <div class="legend-item">
            <span class="legend-color temperature"></span>
            <span>Temperature</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// System control functions
let systemConfig = {};

async function toggleSystem(target) {
    const checkbox = document.getElementById(`toggle-${target}`);
    const statusBadge = document.getElementById(`status-${target}`);
    const statusDot = document.getElementById(`dot-${target}`);
    const card = document.getElementById(`card-${target}`);
    const action = checkbox.checked ? 'on' : 'off';

    // Show updating state
    statusBadge.textContent = "UPDATING";
    statusBadge.dataset.status = "disabled";
    statusDot.dataset.status = "disabled";
    statusBadge.style.color = "var(--warning-color)";
    card.style.opacity = "0.8";

    try {
        const response = await fetch(`/api/toggle_system/${target}/${action}`, { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        const data = await response.json();
        
        if (data.status === 'success') {
            updateServiceUI(target, data.new_state);
            addLog(`Service ${target} turned ${action.toUpperCase()}`, 'info', target.toUpperCase());
        } else {
            throw new Error(data.message || 'Failed to update service');
        }
    } catch (error) {
        console.error(error);
        checkbox.checked = !checkbox.checked; // Revert checkbox
        statusBadge.textContent = "ERROR";
        statusBadge.dataset.status = "error";
        statusDot.dataset.status = "error";
        statusBadge.style.color = "var(--danger-color)";
        addLog(`Failed to toggle ${target}: ${error.message}`, 'error', 'SYSTEM');
        
        // Show error notification
        showNotification(`Failed to update ${target} service`, 'error');
    }
}

function updateServiceUI(target, isActive) {
    const checkbox = document.getElementById(`toggle-${target}`);
    const statusBadge = document.getElementById(`status-${target}`);
    const statusDot = document.getElementById(`dot-${target}`);
    const card = document.getElementById(`card-${target}`);

    checkbox.checked = isActive;
    if (isActive) {
        statusBadge.textContent = "ACTIVE";
        statusBadge.dataset.status = "active";
        statusDot.dataset.status = "active";
        statusBadge.style.color = "var(--success-color)";
        card.style.opacity = "1";
        card.dataset.status = "active";
    } else {
        statusBadge.textContent = "DISABLED";
        statusBadge.dataset.status = "disabled";
        statusDot.dataset.status = "disabled";
        statusBadge.style.color = "var(--text-secondary)";
        card.style.opacity = "0.7";
        card.dataset.status = "disabled";
    }
}

async function loadSystemConfig() {
    try {
        const response = await fetch('/api/get_system_config');
        const config = await response.json();
        
        systemConfig = config;
        
        // Update each service
        for (const [key, value] of Object.entries(config.services || config)) {
            updateServiceUI(key, value);
        }
        
        // Update system stats
        updateSystemStats();
        
        addLog('System configuration loaded successfully', 'info', 'SYSTEM');
    } catch (error) {
        console.error("Failed to load config:", error);
        addLog('Failed to load system configuration', 'error', 'SYSTEM');
    }
}

async function updateSystemStats() {
    try {
        const response = await fetch('/api/system-stats');
        const stats = await response.json();
        
        // 1. Cập nhật Disk Usage
        if (stats.disk_usage !== undefined) {
            const diskElem = document.getElementById('diskUsage');
            if(diskElem) {
                diskElem.textContent = stats.disk_usage + '%';
                // Nếu bạn có thanh progress bar cho disk (tùy chọn)
                // updateProgressBar('diskBar', stats.disk_usage); 
            }
        }

        // 2. Cập nhật Memory Usage
        if (stats.memory_usage !== undefined) {
            const memElem = document.getElementById('memoryUsage');
            if(memElem) {
                memElem.textContent = stats.memory_usage + '%';
                // Gọi hàm đổi màu chữ dựa trên %
                updateColorByValue(memElem, stats.memory_usage);
            }
        }

        // 3. Cập nhật CPU Temp
        if (stats.cpu_temp !== undefined) {
            const tempElem = document.getElementById('cpuTemp');
            if(tempElem) {
                tempElem.textContent = stats.cpu_temp + '°C';
                updateColorByValue(tempElem, stats.cpu_temp, 60, 75); // Ngưỡng: 60 (vàng), 75 (đỏ)
            }
        }
        // const data = await response.json();
        // const temp = data.cpu_temp || 0;
        // // Update gauge text
        // document.getElementById('cpuTemp').innerText = temp + "°C";


        // 4. Cập nhật Power Draw (Trạng thái nguồn)
        if (stats.power_draw) {
            const powerElem = document.getElementById('powerDraw');
            if(powerElem) {
                powerElem.textContent = stats.power_draw;
                // Đổi màu nếu nguồn yếu
                if (stats.power_draw !== "Ổn Định" && stats.power_draw !== "Stable") {
                    powerElem.style.color = "var(--danger-color)";
                } else {
                    powerElem.style.color = "var(--success-color)";
                }
            }
        }

    } catch (error) {
        console.error('Failed to update system stats:', error);
    }
}

// Hàm phụ trợ để đổi màu chữ (Thêm vào nếu chưa có)
function updateColorByValue(element, value, warnThreshold=60, dangerThreshold=80) {
    if (value > dangerThreshold) {
        element.style.color = 'var(--danger-color)';
    } else if (value > warnThreshold) {
        element.style.color = 'var(--warning-color)';
    } else {
        element.style.color = 'var(--text-primary)'; // Hoặc màu mặc định
    }
}

function updateProgressBar(elementId, value) {
    const element = document.getElementById(elementId);
    if (value > 80) {
        element.style.color = 'var(--danger-color)';
    } else if (value > 60) {
        element.style.color = 'var(--warning-color)';
    } else {
        element.style.color = 'var(--text-primary)';
    }
}

function updateTemperatureColor(elementId, temp) {
    const element = document.getElementById(elementId);
    if (temp > 70) {
        element.style.color = 'var(--danger-color)';
    } else if (temp > 60) {
        element.style.color = 'var(--warning-color)';
    } else {
        element.style.color = 'var(--text-primary)';
    }
}

// Service control functions
async function restartService(service) {
    try {
        const response = await fetch(`/api/restart_service/${service}`, { method: 'POST' });
        const data = await response.json();
        
        if (data.status === 'success') {
            addLog(`Service ${service} restarted`, 'info', service.toUpperCase());
            showNotification(`Service ${service} restarted successfully`, 'success');
            
            // Update service status
            setTimeout(() => {
                updateServiceUI(service, true);
            }, 2000);
        }
    } catch (error) {
        console.error(`Failed to restart ${service}:`, error);
        addLog(`Failed to restart ${service}`, 'error', 'SYSTEM');
        showNotification(`Failed to restart ${service}`, 'error');
    }
}

async function configureService(service) {
    // Open configuration modal for the service
    showNotification(`Opening configuration for ${service}`, 'info');
    // Implement configuration modal logic here
}

async function testMicrophone() {
    try {
        const response = await fetch('/api/test_microphone', { method: 'POST' });
        const data = await response.json();
        
        if (data.status === 'success') {
            addLog('Microphone test completed', 'info', 'MIC');
            showNotification('Microphone test completed successfully', 'success');
        }
    } catch (error) {
        console.error('Microphone test failed:', error);
        addLog('Microphone test failed', 'error', 'MIC');
        showNotification('Microphone test failed', 'error');
    }
}

async function testSound() {
    try {
        const response = await fetch('/api/test_sound', { method: 'POST' });
        const data = await response.json();
        
        if (data.status === 'success') {
            addLog('Sound test completed', 'info', 'SOUND');
            showNotification('Sound test completed successfully', 'success');
        }
    } catch (error) {
        console.error('Sound test failed:', error);
        addLog('Sound test failed', 'error', 'SOUND');
        showNotification('Sound test failed', 'error');
    }
}

// Quick Actions
async function startAllServices() {
    if (confirm('Start all system services?')) {
        try {
            const response = await fetch('/api/start_all_services', { method: 'POST' });
            const data = await response.json();
            
            if (data.status === 'success') {
                // Update all services to active
                ['camera', 'ai', 'mic', 'sound'].forEach(service => {
                    updateServiceUI(service, true);
                });
                
                addLog('All services started', 'info', 'SYSTEM');
                showNotification('All services started successfully', 'success');
            }
        } catch (error) {
            console.error('Failed to start all services:', error);
            addLog('Failed to start all services', 'error', 'SYSTEM');
            showNotification('Failed to start all services', 'error');
        }
    }
}

async function stopAllServices() {
    if (confirm('Stop all system services?')) {
        try {
            const response = await fetch('/api/stop_all_services', { method: 'POST' });
            const data = await response.json();
            
            if (data.status === 'success') {
                // Update all services to disabled
                ['camera', 'ai', 'mic', 'sound'].forEach(service => {
                    updateServiceUI(service, false);
                });
                
                addLog('All services stopped', 'info', 'SYSTEM');
                showNotification('All services stopped successfully', 'warning');
            }
        } catch (error) {
            console.error('Failed to stop all services:', error);
            addLog('Failed to stop all services', 'error', 'SYSTEM');
            showNotification('Failed to stop all services', 'error');
        }
    }
}

async function restartAllServices() {
    if (confirm('Restart all system services?')) {
        try {
            const response = await fetch('/api/restart_all_services', { method: 'POST' });
            const data = await response.json();
            
            if (data.status === 'success') {
                // Update all services to active
                ['camera', 'ai', 'mic', 'sound'].forEach(service => {
                    updateServiceUI(service, true);
                });
                
                addLog('All services restarted', 'info', 'SYSTEM');
                showNotification('All services restarted successfully', 'success');
            }
        } catch (error) {
            console.error('Failed to restart all services:', error);
            addLog('Failed to restart all services', 'error', 'SYSTEM');
            showNotification('Failed to restart all services', 'error');
        }
    }
}

async function optimizeSystem() {
    try {
        const response = await fetch('/api/optimize_system', { method: 'POST' });
        const data = await response.json();
        
        if (data.status === 'success') {
            addLog('System optimization completed', 'info', 'SYSTEM');
            showNotification('System optimized successfully', 'success');
            
            // Update stats after optimization
            setTimeout(updateSystemStats, 2000);
        }
    } catch (error) {
        console.error('System optimization failed:', error);
        addLog('System optimization failed', 'error', 'SYSTEM');
        showNotification('System optimization failed', 'error');
    }
}

function showPowerMenu() {
    if (confirm('Power Options\n\n1. Restart System\n2. Shutdown\n3. Cancel')) {
        // Implement power options logic here
        addLog('Power menu accessed', 'info', 'SYSTEM');
    }
}

// Log Management
function addLog(message, level = 'info', service = 'SYSTEM') {
    const logsContainer = document.getElementById('logsContainer');
    const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false });
    
    const logEntry = document.createElement('div');
    logEntry.className = `log-entry ${level}`;
    logEntry.innerHTML = `
        <div class="log-time">${timestamp}</div>
        <div class="log-service">${service}</div>
        <div class="log-message">${message}</div>
        <div class="log-level ${level}">${level.toUpperCase()}</div>
    `;
    
    logsContainer.insertBefore(logEntry, logsContainer.firstChild);
    
    // Keep only last 50 logs
    while (logsContainer.children.length > 50) {
        logsContainer.removeChild(logsContainer.lastChild);
    }
    
    // Auto-scroll to new log
    logsContainer.scrollTop = 0;
}

function clearLogs() {
    if (confirm('Clear all system logs?')) {
        const logsContainer = document.getElementById('logsContainer');
        logsContainer.innerHTML = '';
        addLog('Logs cleared by user', 'info', 'SYSTEM');
    }
}

function refreshLogs() {
    addLog('Logs refreshed', 'info', 'SYSTEM');
}

// Initialize chart
function initPerformanceChart() {
    const ctx = document.getElementById('performanceChart').getContext('2d');
    return new Chart(ctx, {
        type: 'line',
        data: {
            labels: Array.from({length: 20}, (_, i) => i * 5 + 'm'),
            datasets: [
                {
                    label: 'CPU Usage',
                    data: [],
                    borderColor: 'var(--accent-blue)',
                    backgroundColor: 'rgba(96, 165, 250, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Memory Usage',
                    data: [],
                    borderColor: 'var(--secondary-color)',
                    backgroundColor: 'rgba(124, 58, 237, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Temperature',
                    data: [],
                    borderColor: 'var(--warning-color)',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    tension: 0.4,
                    fill: true,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'var(--text-secondary)'
                    }
                },
                y: {
                    beginAtZero: true,
                    max: 100,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'var(--text-secondary)',
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                },
                y1: {
                    position: 'right',
                    beginAtZero: true,
                    max: 100,
                    grid: {
                        drawOnChartArea: false
                    },
                    ticks: {
                        color: 'var(--text-secondary)',
                        callback: function(value) {
                            return value + '°C';
                        }
                    }
                }
            }
        }
    });
}

// Time selector for chart
function setupTimeSelector(chart) {
    document.querySelectorAll('.time-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Update active state
            document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Update chart data based on selected time range
            const timeRange = this.dataset.time;
            updateChartData(chart, timeRange);
        });
    });
}

function updateChartData(chart, timeRange) {
    // Generate dummy data for demonstration
    const dataPoints = 20;
    const newData = Array.from({length: dataPoints}, (_, i) => ({
        cpu: Math.floor(Math.random() * 30) + 50,
        memory: Math.floor(Math.random() * 20) + 60,
        temp: Math.floor(Math.random() * 15) + 45
    }));
    
    chart.data.datasets[0].data = newData.map(d => d.cpu);
    chart.data.datasets[1].data = newData.map(d => d.memory);
    chart.data.datasets[2].data = newData.map(d => d.temp);
    chart.update();
}

// Notification system
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <div class="notification-icon">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'error' ? 'times-circle' : 'info-circle'}"></i>
        </div>
        <div class="notification-content">
            <div class="notification-title">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
            <div class="notification-message">${message}</div>
        </div>
    `;
    
    // Add notification styles if not already present
    if (!document.getElementById('notification-styles')) {
        const styles = document.createElement('style');
        styles.id = 'notification-styles';
        styles.textContent = `
            .notification {
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(145deg, var(--dark-blue-800), var(--card-bg));
                border: 1px solid var(--border-color);
                border-left: 4px solid var(--accent-blue);
                border-radius: var(--radius-lg);
                padding: 1rem 1.5rem;
                display: flex;
                align-items: center;
                gap: 1rem;
                z-index: 9999;
                max-width: 400px;
                transform: translateX(120%);
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: var(--shadow-xl);
            }
            .notification.show {
                transform: translateX(0);
            }
            .notification.success {
                border-left-color: var(--success-color);
            }
            .notification.warning {
                border-left-color: var(--warning-color);
            }
            .notification.error {
                border-left-color: var(--danger-color);
            }
            .notification-icon {
                width: 2.5rem;
                height: 2.5rem;
                border-radius: var(--radius-full);
                background: linear-gradient(135deg, var(--primary-color), var(--accent-blue));
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-size: 1.25rem;
            }
            .notification.success .notification-icon {
                background: linear-gradient(135deg, var(--success-color), #0da271);
            }
            .notification.warning .notification-icon {
                background: linear-gradient(135deg, var(--warning-color), #d97706);
            }
            .notification.error .notification-icon {
                background: linear-gradient(135deg, var(--danger-color), #b91c1c);
            }
            .notification-content {
                flex: 1;
            }
            .notification-title {
                font-weight: 600;
                color: var(--text-primary);
                margin-bottom: 0.25rem;
            }
            .notification-message {
                font-size: 0.875rem;
                color: var(--text-secondary);
            }
        `;
        document.head.appendChild(styles);
    }
    
    document.body.appendChild(notification);
    
    // Show notification
    setTimeout(() => notification.classList.add('show'), 10);
    
    // Remove after 5 seconds
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 5000);
}

// Initialize everything when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Load system configuration
    loadSystemConfig();
    updateSystemStats();
    
    // Initialize performance chart
    const chart = initPerformanceChart();
    setupTimeSelector(chart);
    
    // Initial log entry
    addLog('System control panel initialized', 'info', 'SYSTEM');
    
    // Update stats every 10 seconds
    setInterval(updateSystemStats, 10000);
    
    // Update chart data every 5 seconds
    setInterval(() => {
        const activeTimeBtn = document.querySelector('.time-btn.active');
        if (activeTimeBtn) {
            updateChartData(chart, activeTimeBtn.dataset.time);
        }
    }, 5000);
});
</script>
{% endblock %}